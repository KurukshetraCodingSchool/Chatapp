<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatApp</title>
  <link rel="stylesheet" href="../stylesheets/style.css">
</head>
<body>
  <h1>Chatapp</h1>
  <button id="joinRoom" onclick="joinRoom()">Join new Room</button>
<div class="coversionArea">
  <div class="messages"></div>
  <div class="inputs">
    <input type="text" placeholder="Type A Message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let roomName = null; // ❗ Changed from const to let
  const username = prompt('Enter your Username');
  console.log(username);

  function joinRoom() {
    roomName = prompt('Enter Room Name');
    socket.emit('joinRoom', roomName);
  }

  function incomingMessage(msg) {
    document.querySelector('.messages').innerHTML += `
      <div class="msg incomingMessage" id="${msg._id}" onclick="deleteMessage('${msg._id}')">
        <div class="username">${msg.username}</div>
        <div class="data">${msg.msg}</div>
        <div class="time">${formatTime(msg.timestamp)}</div>
      </div>`;
  }

  function outgoingMessage(msg) {
    document.querySelector('.messages').innerHTML += `
      <div class="msg outgoingMessage" id="${msg._id.to}" onclick="deleteMessage('${msg._id}')>
        <div class="username">${msg.username}</div>
        <div class="data">${msg.msg}</div>
        <div class="time">${formatTime(msg.timestamp)}</div>
      </div>`;
  }

  function deleteMessage(id){
    if(confirm("Delete This Message?")){
      socket.emit('deleteMessage',id);
      document.getElementById(id).remove(); // remove from frontend
    }
  }
  function formatTime(isoString){
    const date = new Date (isoString)
    return `${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
  }
  const input = document.querySelector('input');
  const sendButton = document.querySelector('.inputs button'); // ✅ Better targeting

  function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;

    const MessagePocket = {
      username,
      msg,
      roomName
    };

    outgoingMessage(MessagePocket);
    socket.emit('sony', MessagePocket);
    input.value = '';
  }

  sendButton.addEventListener('click', sendMessage);

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  socket.on('incomingMessage', (message) => {
    incomingMessage(message);
  });
</script>


</body>
</html>